<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: utils/evidenceUtils.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: utils/evidenceUtils.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Evidence utils
 *
 * @module utils/evidenceUtils
 * @author Jesse Kaufman &lt;jesse@jessekaufman.com>
 */
const EvidenceItem = require("../models/evidenceItemModel");
const { validTypes, getStatsQuery } = require("../utils/queryUtils");

/**
 * @typedef {Object} Stat
 * @property {string} type - Type of evidence item
 * @property {number} count_in - Incoming evidence item count
 * @property {number} count_out - Outgoing evidence item count
 */

/**
 * @typedef {('email'|'voicemail'|'video'|'text')} EvidenceItemType
 */

/**
 * Get statistics for evidence items based on the specified types and query.
 *
 * @param {Array.&lt;EvidenceItemType>} include - An array of types to include in the statistics.
 * @param {Object} core_query - The core query object to filter the evidence items.
 * @returns {Promise&lt;Array.&lt;Stat>>} - Promise of an array of statistics objects
 */
exports.getStats = async (include, core_query) => {
  let stats = [];
  let types = null;
  let query = Object.assign({}, core_query);

  // Default to all types if none are specified
  if (!include || !include[0]) {
    types = ["text", "email", "voicemail", "video", "total"];
  } else {
    types = [...include, "total"];
  }

  //
  // Count number of evidence items received/sent per type
  //
  for (let i = 0; i &lt; types.length; i++) {
    if (types[i] !== "total") {
      // If type is not "total", search evidence items of that type
      validTypes.push("");
      if (!validTypes.includes(types[i])) {
        throw new Error("Invalid evidence type");
      }
      query.type = types[i];
    } else {
      // If type is "total", search all evidence items
      delete query.type;
    }

    // Count number of evidence items received/sent
    let counts = await EvidenceItem.aggregate(getStatsQuery(query));

    // Default counts to 0
    let count_in = counts[0]?.in ? counts[0].in : 0;
    let count_out = counts[0]?.out ? counts[0].out : 0;

    // Only add to stats if either count is > 0
    if (count_in > 0 || count_out > 0) {
      stats.push({
        type: types[i],
        count_in: count_in,
        count_out: count_out,
      });
    }
  }

  return stats;
};

/**
 * Get list of dates with in/out counts.
 *
 * @param {Array} include - An array of types to include.
 * @returns {Promise&lt;Array>} - An array of date objects containing date, count_in, and count_out.
 */
exports.getDates = async (include) => {
  // Default to all types if none are specified
  match = {};
  if (include &amp;&amp; include[0]) {
    match = { type: { $in: include } };
  }

  // Get list of dates with in/out counts
  let dates = await EvidenceItem.aggregate([
    { $match: match },
    {
      $group: {
        _id: {
          $dateToString: {
            format: "%Y-%m-%d",
            date: "$date_sent",
          },
        },
        in: {
          $sum: {
            $cond: {
              if: { $eq: ["$direction", "IN"] },
              then: 1,
              else: 0,
            },
          },
        },
        out: {
          $sum: {
            $cond: {
              if: { $eq: ["$direction", "OUT"] },
              then: 1,
              else: 0,
            },
          },
        },
      },
    },
  ]);

  return dates;
};

/**
 * Get list of phone numbers with in counts.
 *
 * @param {Array} include - An array of types to include.
 * @returns {Promise&lt;Array>} - An array of objects containing phone number and count of items.
 */
exports.getNumbers = async () => {
  let numbers = await EvidenceItem.aggregate([
    {
      $match: {
        type: { $in: ["voicemail", "text"] },
        from: {
          $not: {
            $in: ["3162502647", "3164611421"],
          },
        },
      },
    },
    {
      $group: {
        _id: "$from",
        in: {
          $sum: {
            $cond: {
              if: { $eq: ["$direction", "IN"] },
              then: 1,
              else: 0,
            },
          },
        },
      },
    },
  ]);

  return numbers;
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-controllers_evidenceControllers.html">controllers/evidenceControllers</a></li><li><a href="module-utils_evidenceUtils.html">utils/evidenceUtils</a></li><li><a href="module-utils_helpers.html">utils/helpers</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.3</a> on Wed May 22 2024 19:05:04 GMT-0500 (Central Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
